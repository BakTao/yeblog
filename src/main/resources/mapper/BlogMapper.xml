<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tao.yeblog.dao.BlogMapper">

    <select id="pageBlogInfo" parameterType="com.tao.yeblog.model.qo.BlogQO"
            resultType="com.tao.yeblog.model.dto.BlogDTO">
      select t.*
      from
      (
        select t1.blogid blogId,
        t2.loginid userId,
        t3.columnid columnId,
        t3.name columnName,
        t1.title title,
        t1.type type,
        t1.enable enable,
        t1.content content,
        t1.cover cover,
        t1.createtime createTime,
        t1.reason reason,
        count(t4.blogid) praiseNums,
        count(t5.blogid) collectionNums
        from blog t1
        left join blog_user t2 on t1.userid = t2.id
        left join yeblog_db.column  t3 on t1.columnid = t3.id
        left join user_praise t4 on t1.id = t4.blogid
        left join user_collection t5 on t1.id = t5.blogid
        group by t1.id
      ) t
      where 1=1
      <if test="title !=null and title != ''">
        and t.title like (concat('%',#{title},'%'))
      </if>
      <if test="blogId !=null and blogId != ''">
        and t.blogId like (concat('%',#{blogId},'%'))
      </if>
      <if test="userId !=null and userId != ''">
        and t.userId like (concat('%',#{userId},'%'))
      </if>
      <if test="enable !=null and enable != ''">
        and t.enable = #{enable}
      </if>
      <if test="createTimeQ !=null and createTimeQ != ''">
        and t.createTime >= date_format(#{createTimeQ},'%Y-%m-%d')
      </if>
      <if test="createTimeZ !=null and createTimeZ != ''">
        and t.createTime &lt;= date_format(#{createTimeZ},'%Y-%m-%d')
      </if>
      <if test="type !=null and type != ''">
        and t.type in
        <foreach collection="types" item="type" open="(" close=")" separator=",">
          #{type}
        </foreach>
      </if>
      <if test="columnId !=null and columnId != ''">
        and t.columnId in
        <foreach collection="columnIds" item="columnId" open="(" close=")" separator=",">
          #{columnId}
        </foreach>
      </if>
      <if test="collectionNumsQ !=null and collectionNumsQ != ''">
        and t.collectionNums >= #{collectionNumsQ}
      </if>
      <if test="collectionNumsZ !=null and collectionNumsZ != ''">
        and t.collectionNums &lt;= #{collectionNumsZ}
      </if>
      <if test="praiseNumsQ !=null and praiseNumsQ != ''">
        and t.praiseNums >= #{prt.columnIdaiseNumsQ}
      </if>
      <if test="praiseNumsZ !=null and praiseNumsZ != ''">
        and t.praiseNums &lt;= #{praiseNumsZ}
      </if>
    </select>

    <update id="updateBlogInfo" parameterType="com.tao.yeblog.model.dto.BlogDTO">
      update blog t
      <set>
        <if test="enable != null and enable != ''">
          t.enable = #{enable},
        </if>
        <if test="reason != null">
          t.reason = #{reason},
        </if>
        <if test="newColumnId != null and newColumnId != ''">
          t.columnid = (select id from yeblog_db.column where columnid = #{newColumnId}),
        </if>
      </set>
      where 1=1
      <if test="blogId !=null and blogId != ''">
        and t.blogid in
        <foreach collection="blogIds" item="blogId" open="(" close=")" separator=",">
          #{blogId}
        </foreach>
      </if>
      <if test="columnId !=null and columnId != ''">
        and t.columnid = (select id from yeblog_db.column where columnid = #{columnId})
      </if>
    </update>

</mapper>
